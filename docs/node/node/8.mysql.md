---
tag:
  - docker
tags:
  - nodejs | nestjs | docker
categories:
  - node
recommend: 6
sticky: 4
---

# 8.MYSQL

## 一、命令

### 1.创建数据库

~~~mysql
CREATE DATABASE rbac_test DEFAULT CHARACTER SET utf8mb4;
~~~

- rbac_test：数据库的名字
- `DEFAULT CHARACTER SET utf8mb4`：指定字符集为`utf8mb4`，默认是`utf8`，`utf8mb4`是`utf8`的超集，专门用来兼容四字节的Unicode字符。它支持完整的Unicode字符集，包括那些需要四字节来表示的字符，如一些特殊的表情符号和其他扩展字符。‌

### 2.创建表

~~~mysql
CREATE TABLE student(
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'Id',
    name VARCHAR(50) NOT NULL COMMENT '学生名',
    gender VARCHAR(10) NOT NULL COMMENT '性别',
    age INT NOT NULL COMMENT '年龄',
    class VARCHAR(50) NOT NULL COMMENT '班级名',
    score INT NOT NULL COMMENT '分数'
) CHARSET=utf8mb4
~~~

- id 为主键，设置自动增长
- name 为名字，非空
- gender 为性别，非空
- age 为年龄，非空
- class 为班级名，非空
- score 为成绩，非空

### 3.删除表

~~~mysql
drop table student;
~~~

### 4.插入数据

~~~mysql
INSERT INTO student (name, gender, age, class, score)
    VALUES 
        ('张三', '男',18, '一班',90),
        ('李四', '女',19, '二班',85),
        ('王五', '男',20, '三班',70),
        ('赵六', '女',18, '一班',95),
        ('钱七', '男',19, '二班',80),
        ('孙八', '女',20, '三班',75),
        ('周九', '男',18, '一班',85),
        ('吴十', '女',19, '二班',90),
        ('郑十一', '男',20, '三班',60),
        ('王十二', '女',18, '一班',95),
        ('赵十三', '男',19, '二班',75),
        ('钱十四', '女',20, '三班',80),
        ('孙十五', '男',18, '一班',90),
        ('周十六', '女',19, '二班',85),
        ('吴十七', '男',20, '三班',70),
        ('郑十八', '女',18, '一班',95),
        ('王十九', '男',19, '二班',80),
        ('赵二十', '女',20, '三班',75);
~~~

### 5.更新数据

~~~mysql
UPDATE student SET score = 90
    WHERE student.name = '张三'
~~~

- `WHERE`后面接收条件

### 6.删除数据

~~~mysql
DELETE FROM student
	WHERE student.name = '张三'
~~~

- `WHERE`后面接收条件

### 7.查询数据

#### 1.查询表的所有数据

~~~mysql
SELECT * FROM student;
~~~

#### 2.指定查询的列

~~~mysql
SELECT name, score FROM student;
~~~

#### 3.修改返回的列名

~~~mysql
SELECT name as "名字", score as "分数" FROM student;
~~~

#### 4.条件查询 where

~~~mysql
select name as "名字",class as "班级" from student where age >= 19;
~~~

#### 5.多个条件

~~~mysql
select name as '名字',class as '班级' from student where gender='男' and score >= 90;
~~~

#### 6.模糊查询 LIKE

~~~mysql
select * from student where name like '王%'
~~~

#### 7.指定一个集合 in

- in

~~~mysql
select * from student where class in ('一班', '二班');
~~~

- not in

~~~mysql
select * from student where class not in ('一班', '二班');
~~~

#### 8.指定区间 between and

~~~mysql
select * from student where age between 18 and 20;
~~~

#### 9.分页 limit

- 第一页

~~~mysql
select * from student limit 0,5;
~~~

- 第二页

~~~mysql
select * from student limit 5,5;
~~~

#### 10.排序 order by

~~~mysql
select name,score,age from student order by score asc,age desc;
~~~

- order by 指定根据 score 升序排列，如果 score 相同再根据 age 降序排列。
- asc：升序
- desc：降序

#### 11.统计平均值 AVG

~~~mysql
SELECT class as '班级', AVG(score) AS '平均成绩' FROM student GROUP BY class ORDER BY '平均成绩' DESC;
~~~

- 分组统计之后过滤，不使用`where`，使用`having`

  - ~~~mysql
    SELECT class,AVG(score) AS avg_score FROM student GROUP BY class HAVING avg_score > 90;
    ~~~

#### 12.计数 count

~~~mysql
select class, count(*) as count from student group by class;
~~~

- \* 就代表当前行

#### 13.去重  distinct

~~~mysql
SELECT DISTINCT class FROM student;
~~~

#### 14.聚合函数

用于对数据的统计，比如 AVG、COUNT、SUM、MIN、MAX。

~~~mysql
select avg(score) as '平均成绩',count(*) as '人数',sum(score) as '总成绩',min(score) as '最低分', max(score) as '最高分' from student
~~~

#### 15.字符串函数

用于对字符串的处理，比如 CONCAT、SUBSTR、LENGTH、UPPER、LOWER。

~~~mysql
SELECT CONCAT('xx', name, 'yy'), SUBSTR(name,2,3), LENGTH(name), UPPER('aa'), LOWER('TT') FROM student;
~~~

- substr 第二个参数表示开始的下标（**mysql 下标从 1 开始**），所以 substr('一二三',2,3) 的结果是 '二三'，也可以不写结束下标 substr('一二三',2)

#### 16.数值函数

用于对数值的处理，比如 ROUND、CEIL、FLOOR、ABS、MOD。

~~~mysql
SELECT ROUND(1.234567, 2), CEIL(1.234567), FLOOR(1.234567), ABS(-1.234567), MOD(5, 2);
~~~

#### 17.日期函数

对日期、时间进行处理，比如 DATE、TIME、YEAR、MONTH、DAY

~~~mysql
SELECT YEAR('2023-06-01 22:06:03'), MONTH('2023-06-01 22:06:03'),DAY('2023-06-01 22:06:03'),DATE('2023-06-01 22:06:03'), TIME('2023-06-01 22:06:03');
~~~

#### 18.条件函数

根据条件是否成立返回不同的值，比如 IF、CASE

- IF

~~~mysql
select name, if(score >=60, '及格', '不及格') from student;
~~~

- CASE

~~~mysql
SELECT name, score, CASE WHEN score >=90 THEN '优秀' WHEN score >=60 THEN '良好'ELSE '差' END AS '档次' FROM student;
~~~

- if 和 case 函数和 js 里的 if、swtch 语句很像，很容易理解
- if 函数适合单个条件，case 适合多个条件

#### 19.系统函数

用于获取系统信息，比如 VERSION、DATABASE、USER。

~~~mysql
select VERSION(), DATABASE(), USER()
~~~

#### 20.其他函数

NULLIF、COALESCE、GREATEST、LEAST。

- NULLIF：如果相等返回 null，不相等返回第一个值。

  - ~~~mysql
    select NULLIF(1,1), NULLIF(1,2);
    ~~~

- COALESCE：返回第一个非 null 的值：

  - ~~~mysql
    select COALESCE(null, 1), COALESCE(null, null, 2)
    ~~~

- GREATEST、LEAST：返回几个值中最大、最小的。

  - ~~~mysql
    select GREATEST(1,2,3),LEAST(1,2,3,4);
    ~~~

#### 21.类型转换函数

转换类型为另一种，比如 CAST、CONVERT、DATE_FORMAT、STR_TO_DATE。

~~~mysql
select greatest(1, convert('123', signed),3);
~~~

~~~mysql
select greatest(1, cast('123' as signed),3);
~~~

- CAST、CONVERT：这里"123"是字符串不会被比较，需要通过CAST、CONVERT转换类型

  - signed：整型；
  - unsigned：无符号整型
  - decimal：浮点型；
  - char：字符类型；
  - date：日期类型；
  - time：时间类型；
  - datetime：日期时间类型；
  - binary：二进制类型

- DATE_FORMAT

  - ~~~mysql
    SELECT DATE_FORMAT('2022-01-01', '%Y年%m月%d日');
    ~~~

  - 2022年01月01日

- STR_TO_DATE

  - ~~~mysql
    SELECT STR_TO_DATE('2023-06-01', '%Y-%m-%d');
    ~~~

  - 2023-06-01

### 8.子查询和EXISTS

#### 1.子查询

1. 查询

   - 查询成绩高于全校平均成绩的学生记录

     ~~~mysql
     SELECT * FROM student WHERE score > (SELECT AVG(score) FROM student);
     ~~~

     - 先一个 select 语句查询学生的平均分，然后查询分数大于这个平均分的学生。

2. 插入

   - ~~~mysql
     INSERT INTO avg_price_by_category (category, avg_price) 
         SELECT category, AVG(price) FROM product GROUP BY category;
     ~~~

   - 把 product 产品表里的分类和平均价格查出来插入avg_price_by_category

3. 更新

   - ~~~mysql
     UPDATE employee SET name = CONCAT('技术-', name) 
         WHERE department_id = (
             SELECT id FROM department WHERE name = '技术部'
         );
     ~~~

   - 把技术部所有人的 name 前加上 “技术-”

4. 删除

   - ~~~mysql
     DELETE FROM employee WHERE department_id = (
         SELECT id FROM department WHERE name = '技术部'
     );
     ~~~

   - 删除技术部所有的员工

#### 2.EXISTS

查询有员工的部门。

~~~mysql
SELECT name FROM department
    WHERE EXISTS (
        SELECT * FROM employee WHERE department.id = employee.department_id
    );
~~~

- 对每个 department，在子查询里查询它所有的 employee。
- 如果存在员工，那么条件成立，就返回这个部门的 name。
- 这就是 EXISTS 的作用：子查询返回结果，条件成立，反之不成立。

查询所有没有员工的部门

~~~mysql
SELECT name FROM department
    WHERE NOT EXISTS (
            SELECT * FROM employee WHERE department.id = employee.department_id
    );
~~~

### 9.join查询

~~~mysql
SELECT * FROM user JOIN id_card ON user.id = id_card.user_id;
~~~

~~~mysql
SELECT user.id, name, id_card.id as card_id, card_name 
    FROM user
    JOIN id_card ON user.id = id_card.user_id;
~~~

这里用到了 JOIN ON，也就是连接 user 和 id_card 表，关联方式是 user.id = id_card.user_id，也就是 id_card 表中的外键关联 user 表的主键。

多表关联查询，语法是 JOIN ON

 JOIN ON 其实默认是 INNER JOIN ON，相当于这么写：

~~~mysql
SELECT user.id, name, id_card.id as card_id, card_name 
    FROM user
    INNER JOIN id_card ON user.id = id_card.user_id;
~~~

- INNER JOIN 是只返回两个表中能关联上的数据
- LEFT JOIN 是额外返回左表中没有关联上的数据
- RIGHT JOIN 是额外返回右表中没有关联上的数据
- **在 FROM 后的是左表，JOIN 后的表是右表**

多个表

~~~mysql
SELECT * FROM article a 
    JOIN article_tag at ON a.id = at.article_id
    JOIN tag t ON t.id = at.tag_id
    WHERE a.id = 1
~~~

