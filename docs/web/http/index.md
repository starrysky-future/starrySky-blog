---
tag: http
tags: 前端
categories:
  - 大前端
recommend: 1
---

# HTTP 知识体系

超文本传输协议，用于两点之间传输文字、图片、音频、视频等超文本数据的约定和规范。

## 一、HTTP 的特点和缺点

### 特点

- 无状态：每一次请求都是独立的，请求结束不会记录连接的任何信息
- 灵活：通过 http 协议中`content-type`标记，可以传输任意数据类型的数据对象
- 请求-应答模式：一方发出消息，另一方接收消息做出应答

### 缺点

- 无状态：请求不会记录任何连接信息，因此如果后续的请求需要用到前面的信息，它就必须重新传输，这就可能导致传输的数据量增大
- 明文传输：报文（header 部分）使用的是明文，直接将信息暴露给外界，给攻击者带来便利
- 队头阻塞：当 http 开始长连接时，共用一个 tcp 连接，当某个请求耗时过长时，就会阻塞其他请求，造成队头阻塞

## 二、HTTP 报文的组成

### HTTP 报文

请求报文和响应报文

**请求报文**：请求行、请求头、空行、请求体

- 请求行：包含 http 方法，请求地址，http 协议以及版本
- 请求头：一些 key：value，告诉服务端需要哪些资源以及类型
- 空行：用于区分头部和实体，告诉服务端怎么解析
- 请求体：请求的参数

**响应报文**：状态行、响应头、空行、响应体

- 状态行：包含 http 协议以及版本，数字状态码，状态码英文名称
- 响应头：一些 key：value，告诉服务端需要哪些资源以及类型
- 空行：用于区分头部和实体，告诉服务端怎么解析
- 响应体：服务端返回的数据

### 三、HTTP 的请求方法

### HTTP1.0

`GET`、`POST`、`HEAD`

### HTTP1.1

`PUT`、`PATCH`、`DELETE`、`OPTIONS`、`POST`、`CONNECT`

| 方法    | 描述                                       |
| ------- | ------------------------------------------ |
| GET     | 获取资源                                   |
| POST    | 传输资源，通常会造成服务器资源的修改       |
| HEAD    | 获得报文首部                               |
| PUT     | 更新资源                                   |
| PATCH   | 对 PUT 的补充，对已知资源部分更新          |
| DELETE  | 删除资源                                   |
| OPTIONS | 列出请求资源支持的请求方法，用来跨域请求   |
| TRACE   | 追踪请求/响应路径，用于测试或诊断          |
| CONNECT | 将连接改为管道方式用于代理服务器(隧道代理) |

### GET 和 POST 的区别

- GET 请求参数会被浏览器历史记录保存，而 POST 请求参数不会被保留
- GET 请求参数是拼接在 url 上，POST 请求的参数在请求体里
- 浏览器对 url 的长度有限制，因此 GET 请求的参数大小会被限制，POST 请求参数基本上没有限制
- GET 请求的参数直接暴露在 URL 上，相对 POST 来说更不安全

## 四、常见 HTTP 状态码

| 状态码 | 描述                                                                                    |
| ------ | --------------------------------------------------------------------------------------- |
| 200    | 请求成功                                                                                |
| 206    | 已完成指定范围的请求(带 Range 头的 GET 请求),场景如 video,audio 播放文件较大,文件分片时 |
| 301    | 永久重定向                                                                              |
| 302    | 临时重定向                                                                              |
| 304    | 请求资源未修改，可以使用缓存的资源，不用在服务器取                                      |
| 400    | 请求有语法错误                                                                          |
| 401    | 没有权限访问                                                                            |
| 403    | 服务器拒绝执行请求，场景如不允许直接访问，只能通过服务器访问时                          |
| 404    | 请求资源不存在                                                                          |
| 500    | 服务器内部错误，无法完成请求                                                            |
| 503    | 请求未完成，因服务器过载、宕机或维护等                                                  |

## 五、长连接

- HTTP1.0 协议采用的是“请求-应答”模式，每个请求/应答客户端和服务端都会新建一个请求，请求完成后立即断开
- HTTP1.1 协议支持长连接模式，在请求头添加`Connection:Keep-Alive`，开启长连接模式，建立一个 TCP 连接后客户端和服务端的连接就持续有效

### 长连接的优缺点

#### 优点

- 减少 CPU 及内存的使用，因为不需要经常建立和关闭连接
- 支持管道化的请求和响应模式
- 减少了网络阻塞，因为减少了 TCP 请求
- 减少了后续请求的响应时间，因为不用通过三次握手建立连接和四次挥手断开连接
- 发生错误的时候，也可以在不关闭连接的时候进行错误提示

#### 缺点

- 长时间保持连接会导致服务器资源浪费
- 可能造成队头阻塞

### 长连接关闭设置

- 客户端配置：请求头声明`Connection:close`，本次通信完成之后关闭连接
- 服务端配置：`keepalive_timeout`设置长连接超时时间，`keepalive_requests`设置长连接请求次数上限

## 六、管道化

- 使用长连接时，通信是：请求 1->响应 1->请求 2->响应 2->请求 3->响应 3
- 管道化方式：请求 1->请求 2->请求 3->响应 1->响应 2->响应 3

管道化：在同一个 TCP 连接里发一个请求不必等其回来就可以继续发请求出去，这可以减少整体的响应时间，但服务器还是会按照请求的发起顺序进行响应，如果前面的请求响应很慢，就会造成队头阻塞问题

### 特点

- 管道化机制通过持久化连接完成，在 HTTP1.1 才支持
- 只有 GET 请求和 HEAD 请求支持，POST 请求有限制
- 管道化不会影响响应的顺序

## 七、队头阻塞

长连接开启管道化的时候，当前面的请求响应过慢时，就会阻塞后面的请求

- 并发连接：一个域名可以分配多个长连接，相当于增加任务队列，现在的浏览器标准一个域名并发连接可以有 6~8 个
- 域名分片：多准备几个二级域名

## 八、HTTP 代理

常见代理有两种：普通代理（中间人代理）、隧道代理

### 普通代理

代理服务器相当于一个中间人为客户端和服务端两边传递东西

用处：过滤、缓存、负载均衡

### 隧道代理

客户端通过 connect 方法请求隧道代理创建一个可以到任意目标服务器和端口的 TCP 连接，创建成功之后隧道代理只做请求和响应的转发，中间它不会做任何处理。

HTTPS 服务需要网站有证书，而代理服务器是没有的，所以浏览器和代理服务器之间建立不了 TLS，所以隧道代理会把浏览器的数据原样透传，这样就可以实现通过中间代理和服务端进行 TLS 握手，然后进行加密传输

### 代理服务器的好处

- 突破访问限制：使用国外的代理服务器，就可以访问国外的网站
- 安全性更高：通过这种方式可以隐藏自己的 IP
- 负载均衡：代理服务器通过特定的算法（随机算法、轮询、一致性 hash）把请求分发给不同的源服务器，让各个源服务器负载尽量均衡
- 缓存代理：将内容缓存到代理服务器

## 九、正向代理和反向代理

### 正向代理

工作在客户端的代理为正向代理。使用正向代理的时候，需要在客户端配置需要使用的代理服务器，正向代理对服务端透明。比如抓包工具 Fiddler、Charles

作用：缓存、访问无法访问的网站

### 反向代理

工作在服务端的代理为反向代理。反向代理对客户端透明。如 Nginx

作用：负载均衡、服务端缓存、日志

## 十、HTTP 缓存

### 强缓存

1. HTTP1.0 使用的是 Expires
2. HTTP1.1 使用的是 Cache-Control
3. Cache-Control 的优先级更高

#### Expires

表示的是**过期时间**，时间是相对于服务器的时间，从响应头返回，在这个过期时间之前都可以从缓存中获取数据，无需再次请求。

**问题**：服务器的时间可能和浏览器的时间不一样

#### Cache-Control

表示的是**过期时长**，对应的字段是 max-age：`Cache-Control: max-age=6000`

### 协商缓存

1. HTTP1.0 使用的是 Last-Modified
2. HTTP1.1 使用的是 ETag
3. ETag 的优先级更高

#### Last-Modified

表示的是**最后修改时间**

1. 浏览器第一次请求资源后服务器会在响应头加上这个字段
2. 浏览器再次请求时，会将这个字段给到 if-modified-since
3. 服务器拿到字段之后，会去跟资源的最后修改时间进行比较
4. 如果值小于最后修改时间，返回新的资源，并更新 Last-Modified 的值
5. 否则返回 304，浏览器取用缓存的资源

**问题**：Last-Modified 能够感应级别是秒级，如果资源在 1 秒内做了更改，那么 Last-Modified 没有变化

#### ETag

表示的是**对资源生成的唯一标识**

1. 浏览器第一次请求资源后服务器会在响应头加上这个字段
2. 浏览器再次请求时，会将这个字段给到 if-None-Match
3. 服务器接收到 If-None-Match 后，会跟服务器上该资源的 ETag 进行比对
4. 如果两者不一样，返回新的资源，并更新 ETag 的值
5. 否则返回 304，浏览器取用缓存的资源

## 十一、HTTPS

HTTPS 是超文本传输安全协议，即 HTTP+SSL/TLS，多了一个安全层

## 十二、HTTP 和 HTTPS 的区别

- HTTP 是`明文传输`，不安全的，HTTPS 是`加密传输`，安全的多
- HTTP 标准端口是`80`，HTTPS 标准端口是`443`
- HTTP 不用认证证书`免费`，HTTPS 需要认证证书`要钱`
- `连接方式不同`，HTTP 三次握手，HTTPS 中 TLS1.2 版本 7 次，TLS1.3 版本 6 次
- HTTP 是`无状态`的，HTTPS 是`有状态`的

## 十三、HTTP2.0

1. 使用新的二进制协议，不再是纯文本，缩小了请求体积
2. 多路复用，同域名下的所有通信都在但单个连接下完成，单个连接可以承载任意数量的双向数据流，数据流以消息的形式发送，一个消息包含一个或多个帧，多个帧可以乱序发送，后面通过帧首部的流标识进行组装(**解决应用层的队头阻塞问题**)
3. 允许服务端主动推送数据到客户端

## 十四、HTTP3.0/QUIC

TCP 在丢包的时候会进行重传，前面有一个包没收到，就只能把后面的包放到缓冲区，应用层无法取数据。为了解决这个问题，Google 又发明了`QUIC协议`。2018 年改名为 HTTP3.0

- 在传输层，使用 UDP 替代 TCP
- 实现了一套新的拥塞控制算法，彻底解决了 TCP 中的队头阻塞问题
- UDP 不提供可靠的传输，但 QUIC 在 UDP 的基础上增加了一层来保证数据可靠性传输
